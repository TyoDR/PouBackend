<!doctype html>
<html lang="id"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Pou AI Voice Chat Character (Secure Backend)</title> 
  <style type="text/css">
/* --- GAYA POU (Tidak Berubah) --- */
*, *:before, *:after { box-sizing: border-box; transition: none; }
:root { --bg: rgb(241, 226, 136); --size: 70; --unit: calc(var(--size) / 512 * 1vmin); --pou-color: #D3A05A; --eye-size: calc(512 * var(--unit) * 0.23); }
body { background-color: var(--bg); height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0; font-family: Arial, sans-serif; }
.controls { position: fixed; top: 5vh; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; text-align: center; z-index: 1000; }
.pou { height: calc(512 * var(--unit)); width: calc(512 * var(--unit)); position: relative; margin-bottom: 20vh; }
.pou__body { height: 100%; width: 100%; position: relative; }
.pou__body--top { height: 71%; background-color: var(--pou-color); width: 81.47%; border-radius: 146% 146% 0 0/ 278% 278% 0 0; clip-path: inset(0 0 40% 0); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid black; overflow: hidden; z-index: 10; }
.pou__body--bottom { height: 71%; background-color: rgb(167, 0, 0); width: 75.8%; border-radius: 0 0 50% 50%/ 0 0 24% 24%; clip-path: inset(59.6% 0 0 0); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid black; z-index: 5; }
.pou__body:after { content: ''; position: absolute; border-radius: 100%; transform: rotate(21deg); top: 13%; left: 44%; height: 17%; width: 30%; background-color: darkred; clip-path: inset(0 0 50% 0); z-index: 15; }
.pou__body::before { content: ''; position: absolute; border-radius: 100%; transform: rotate(21deg); top: 11%; left: 60%; height: 4%; width: 5%; background-color: rgb(66, 0, 0); z-index: 15; }
.eye-container { position: absolute; top: 16%; left: 50%; transform: translateX(-50%); display: flex; gap: calc(512 * var(--unit) * 0.05); z-index: 20; }
.eye { width: calc(512 * var(--unit) * 0.18); height: calc(512 * var(--unit) * 0.23); background: white; border-radius: 50%; border: 2px solid black; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; transition: border-color 0.3s, box-shadow 0.3s; }
.pupil { width: 35%; height: 35%; background: black; border-radius: 50%; position: absolute; transition: transform 0.1s linear; }
.reflection { width: 15%; height: 15%; background: white; border-radius: 50%; position: absolute; top: 10%; left: 15%; }
.eyelid { position: absolute; width: 100%; height: 100%; background: var(--pou-color); border-radius: 50%; top: -100%; transition: top 0.1s linear; }
.listening { border-color: #00aaff; box-shadow: 0 0 10px rgba(0, 170, 255, 0.5); animation: pulse-listening 1s infinite alternate; }
@keyframes pulse-listening { 0% { box-shadow: 0 0 10px rgba(0, 170, 255, 0.5); } 100% { box-shadow: 0 0 15px rgba(0, 170, 255, 0.8); } }
.pou-mouth-wrapper { position: absolute; top: 55%; left: 50%; transform: translateX(-50%); z-index: 20; }
.mouth { width: calc(512 * var(--unit) * 0.25); height: calc(512 * var(--unit) * 0.04); background: black; border-radius: 5px; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; transition: height 0.1s ease-out; }
.mouth-inner { width: 90%; height: 4px; background: limegreen; border-radius: 2px; position: absolute; transition: transform 0.1s ease-out; }
.button-container { display: flex; gap: 15px; margin-top: 10px; justify-content: center; }
.action-button { padding: 10px 15px; font-size: 14px; cursor: pointer; background-color: #333; color: white; border: none; border-radius: 5px; transition: background-color 0.3s, transform 0.1s; }
.action-button:disabled { background-color: #999; cursor: not-allowed; }
.info-text { margin-top: 10px; color: #555; font-size: 13px; padding: 5px; background: rgba(255, 255, 255, 0.7); border-radius: 5px; min-height: 20px; }
#chat-box-container { position: fixed; bottom: 5vh; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display: flex; gap: 5px; padding: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
#chat-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
#refresh-button { padding: 8px 5px; background-color: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 11px; }
#refresh-button:hover:not(:disabled) { background-color: #da190b; }
#refresh-button:disabled { background-color: #999; cursor: not-allowed; }
#send-button { padding: 8px 8px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 12px; }
#send-button:hover:not(:disabled) { background-color: #45a049; }
#send-button:disabled { background-color: #999; cursor: not-allowed; }
.pou { margin-bottom: 20vh; }
</style> 
 </head> 
 <body> 
  <div class="controls"> 
   <div class="button-container"> <button id="permission-button" class="action-button">Aktifkan Sensor Gerak (Gyro)</button> <button id="talk-button" class="action-button">Mulai Bicara (Mic)</button> 
   </div> 
   <div class="info-text" id="status-text"> <span style="font-weight: bold; color: #cc0000;">Loading...</span> 
   </div> 
   <div class="info-text" id="transcript-text" style="font-weight: bold; color: #008000;"></div> 
  </div> 
  <div class="pou"> 
   <div class="pou__body"> 
    <div class="pou__body--top"> 
     <div class="eye-container"> 
      <div class="eye" id="eye-left"> 
       <div class="pupil"> 
        <div class="reflection"></div> 
       </div> 
       <div class="eyelid"></div> 
      </div> 
      <div class="eye" id="eye-right"> 
       <div class="pupil"> 
        <div class="reflection"></div> 
       </div> 
       <div class="eyelid"></div> 
      </div> 
     </div> 
     <div class="pou-mouth-wrapper"> 
      <div class="mouth" id="mouth"> 
       <div class="mouth-inner" id="mouthInner"></div> 
      </div> 
     </div> 
    </div> 
    <div class="pou__body--bottom"></div> 
   </div> 
  </div> 
  <div id="chat-box-container"> 
   <input type="text" id="chat-input" placeholder="Ketik pesan Anda di sini..."> <button id="send-button">Kirim</button> <button id="refresh-button">Reset</button> 
  </div> 
  <audio id="voice" preload="auto"></audio> 
  <script type="text/javascript">
// =========================================================================
// KONSTANTA & VARIABEL
// =========================================================================
const MAX_PUPIL_DISTANCE = 25; 
const IDLE_MOVEMENT_RANGE = 7; 
const eyes = document.querySelectorAll('.eye');
const mouth = document.getElementById('mouth');
const mouthInner = document.getElementById('mouthInner');
const gyroButton = document.getElementById('permission-button');
const talkButton = document.getElementById('talk-button');
const statusText = document.getElementById('status-text');
const transcriptText = document.getElementById('transcript-text');
const chatInput = document.getElementById('chat-input'); 
const sendButton = document.getElementById('send-button'); 
const refreshButton = document.getElementById('refresh-button'); 

let CONVERSATION_HISTORY = [];
let isListening = false;
let isSpeaking = false;
let isProcessing = false; 
let isBlinking = false;
let hasGreeted = false;
let mouthInterval;

const SENSITIVITY = 0.4; 
const MAX_ANGLE = 40; 

// *** URL DEPLOYMENT APPS SCRIPT ANDA (URL yang Anda berikan) ***
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyu7oZrPtv841FvD6PToUgNxR0UHrjvXaKMDNkO7xoto6Pq2FS2aLGiWaXhV4QVvLHI/exec'; 

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const SpeechSynthesis = window.speechSynthesis;
const SpeechSynthesisUtterance = window.SpeechSynthesisUtterance;
let recognition;


// =========================================================================
//                             FUNGSI PERGERAKAN WAJAH
// =========================================================================

function blinkRandomly() {
    if (isBlinking) return;
    isBlinking = true;
    const eyelids = document.querySelectorAll('.eyelid');
    eyelids.forEach(eyelid => { eyelid.style.top = '0%'; });
    setTimeout(() => {
        eyelids.forEach(eyelid => { eyelid.style.top = '-100%'; });
        isBlinking = false;
    }, 100);
}

function setRandomBlinkInterval() {
    const randomTime = Math.random() * 4000 + 3000;
    setTimeout(() => {
        blinkRandomly();
        setRandomBlinkInterval();
    }, randomTime);
}

function moveEyesRandomly() {
    if (isListening || isSpeaking || isProcessing || gyroButton.disabled) {
        setTimeout(moveEyesRandomly, Math.random() * 3000 + 2000); 
        return;
    }

    const randomX = (Math.random() - 0.5) * 2 * IDLE_MOVEMENT_RANGE; 
    const randomY = (Math.random() - 0.5) * 2 * IDLE_MOVEMENT_RANGE;

    eyes.forEach(eye => {
        const pupil = eye.querySelector('.pupil');
        pupil.style.transform = `translate(${randomX}px, ${randomY}px)`;
    });

    setTimeout(moveEyesRandomly, Math.random() * 3000 + 2000);
}

function setMouthSpeaking(speaking) {
    if (mouthInterval) clearInterval(mouthInterval);
    isSpeaking = speaking;
    
    if (speaking) {
        const pouUnit = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--unit'));
        const minHeight = 4 * pouUnit;
        const maxHeight = 10 * pouUnit; 

        mouthInterval = setInterval(() => {
            const mouthHeight = minHeight + Math.random() * (maxHeight - minHeight); 
            mouth.style.height = `${mouthHeight}px`;

            const scaleX = 0.8 + Math.random() * 0.4;
            const scaleY = 1 + Math.random() * 2;
            const translateY = Math.random() * 2 - 1; 

            mouthInner.style.transform = `scaleX(${scaleX}) scaleY(${scaleY}) translateY(${translateY}px)`;
        }, 80);
    } else {
        mouth.style.height = 'calc(512 * var(--unit) * 0.04)';
        mouthInner.style.transform = `scaleX(1) scaleY(1) translateY(0px)`;
    }
}

function setCharacterListening(listening) {
    isListening = listening;
    eyes.forEach(eye => {
        if (listening) {
            eye.classList.add('listening');
        } else {
            eye.classList.remove('listening');
        }
    });
}

// =========================================================================
//                             FUNGSI GYROSCOPE
// =========================================================================

function handleDeviceOrientation(event) {
    let beta = event.beta; 
    let gamma = event.gamma;

    beta = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, beta));
    gamma = Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, gamma));

    const normalizedX = (gamma / MAX_ANGLE) * SENSITIVITY;
    const normalizedY = (beta / MAX_ANGLE) * SENSITIVITY; 

    const deltaX = normalizedX * MAX_PUPIL_DISTANCE;
    const deltaY = -normalizedY * MAX_PUPIL_DISTANCE; 

    eyes.forEach(eye => {
        const pupil = eye.querySelector('.pupil');
        pupil.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    });
}

function requestSensorPermission() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                    gyroButton.textContent = 'Sensor Gerak AKTIF';
                    gyroButton.disabled = true;
                    statusText.textContent = 'Arahkan HP Anda untuk menggerakkan mata!';
                } else {
                    statusText.textContent = 'Izin sensor gerak tidak diberikan.';
                }
            })
            .catch(error => {
                 statusText.textContent = 'Gagal mengaktifkan sensor. Coba di Chrome/Edge.';
            });
    } else {
        window.addEventListener('deviceorientation', handleDeviceOrientation);
        gyroButton.textContent = 'Sensor Gerak AKTIF';
        gyroButton.disabled = true;
        statusText.textContent = 'Arahkan HP Anda untuk menggerakkan mata!';
    }
}

// =========================================================================
//                          FUNGSI TTS NATIVE (SpeechSynthesis)
// =========================================================================

function speakResponse(text) {
    if (!text || !SpeechSynthesis) {
        // Jika TTS tidak didukung, langsung akhiri proses
        isProcessing = false;
        talkButton.disabled = !SpeechRecognition;
        sendButton.disabled = false;
        refreshButton.disabled = false;
        chatInput.disabled = false; // <<< PERBAIKAN 1: Re-enable chatInput saat TTS tidak didukung
        if (!hasGreeted) hasGreeted = true;
        if (isListening) startListening();
        else statusText.textContent = 'Siap. Tekan "Mulai Bicara" atau ketik pesan.';
        return;
    }
    
    if (SpeechSynthesis.speaking) {
        SpeechSynthesis.cancel();
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'id-ID'; 

    utterance.onstart = () => {
        setMouthSpeaking(true);
    };
    
    utterance.onend = () => {
        setMouthSpeaking(false);
        isProcessing = false; 
        
        // Re-enable tombol & input
        talkButton.disabled = !SpeechRecognition; 
        sendButton.disabled = false;
        refreshButton.disabled = false; 
        chatInput.disabled = false; // <<< PERBAIKAN 2: Re-enable chatInput setelah selesai bicara
        
        if (!hasGreeted) hasGreeted = true;

        if (isListening) {
             startListening(); 
        } else {
            statusText.textContent = 'Siap. Tekan "Mulai Bicara" atau ketik pesan.';
        }
    };

    utterance.onerror = (event) => {
         console.error('Speech Synthesis Error:', event.error);
         setMouthSpeaking(false);
         isProcessing = false;
         
         // Re-enable tombol & input (saat error)
         talkButton.disabled = !SpeechRecognition;
         sendButton.disabled = false;
         refreshButton.disabled = false; 
         chatInput.disabled = false; // <<< PERBAIKAN 3: Re-enable chatInput saat error
         
         statusText.textContent = 'Error Suara. Siap.';
         if (isListening) startListening();
    };

    SpeechSynthesis.speak(utterance);
}


// =========================================================================
//                          FUNGSI LOGIKA GEMINI BARU (Via Apps Script)
// =========================================================================

function validateSetup() {
    const micSupported = !!(SpeechRecognition && SpeechSynthesis);
    
    if (!micSupported) {
        talkButton.textContent = 'Mic (Tidak Didukung)';
        talkButton.disabled = true;
    }

    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.trim() === '') {
        statusText.innerHTML = '<span style="color:red; font-weight:bold;">Error: URL Apps Script masih kosong.</span>';
        talkButton.disabled = true;
        sendButton.disabled = true;
        refreshButton.disabled = true; 
        return false;
    }
    
    if (!APPS_SCRIPT_URL.includes('/exec')) {
        statusText.innerHTML = '<span style="color:red; font-weight:bold;">Error: URL Apps Script harus diakhiri dengan /exec. Periksa deployment.</span>';
        talkButton.disabled = true;
        sendButton.disabled = true;
        refreshButton.disabled = true; 
        return false;
    }
    
    return true; 
}

async function getGeminiReply(userCommand) {
    
    statusText.textContent = 'Pou Berpikir...';
    
    const requestBody = {
        userCommand: userCommand,
        history: CONVERSATION_HISTORY
    };

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            // Headers dihapus untuk perbaikan CORS/Failed to fetch
            body: JSON.stringify(requestBody),
        });

        const textResponse = await response.text();

        let data;
        try {
            data = JSON.parse(textResponse);
        } catch (e) {
            throw new Error(`Koneksi Gagal/Izin Salah. Server mengembalikan non-JSON: ${textResponse.substring(0, 50)}...`);
        }
        
        if (data.status === 'error') {
            throw new Error(data.reply || data.message || 'Kesalahan tak terduga dari server.');
        }
        
        const replyText = data.reply;
        
        CONVERSATION_HISTORY = data.newHistory;
        
        return replyText;

    } catch (error) {
        console.error('Gemini Error (via Apps Script):', error);
        
        isProcessing = false; 
        talkButton.disabled = !SpeechRecognition;
        sendButton.disabled = false;
        refreshButton.disabled = false; 
        chatInput.disabled = false; // Pastikan input aktif walau ada error fetch

        let errorMsg = error.message;
        if (errorMsg.includes("Failed to fetch")) {
             errorMsg = "Gagal terhubung ke Apps Script (Masalah Jaringan/CORS).";
        }
        
        statusText.textContent = `Pou: Kesalahan AI: ${errorMsg.substring(0, 80)}. Coba bersihkan obrolan.`;
        return `Kesalahan AI: ${errorMsg.substring(0, 80)}. Coba bersihkan obrolan.`;
    }
}

// FUNGSI BARU UNTUK MEMBERSIHKAN CHAT
async function clearChatAndHistory() {
    if (!validateSetup()) return;

    isProcessing = true;
    talkButton.disabled = true;
    sendButton.disabled = true;
    refreshButton.disabled = true;
    chatInput.disabled = true;

    try {
        const response = await fetch(APPS_SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'clear' })
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            CONVERSATION_HISTORY = []; 
            chatInput.value = ''; 
            transcriptText.textContent = 'Riwayat percakapan telah diatur ulang.';
            statusText.textContent = 'Obrolan baru siap. Pou telah melupakan percakapan sebelumnya.';
        } else {
            throw new Error(data.message || "Gagal membersihkan riwayat di server.");
        }
    } catch (error) {
        statusText.textContent = `Error Reset: ${error.toString()}`;
    } finally {
        isProcessing = false;
        talkButton.disabled = !SpeechRecognition;
        sendButton.disabled = false;
        refreshButton.disabled = false;
        chatInput.disabled = false; // Diaktifkan kembali setelah Reset
    }
}


// =========================================================================
//                          FUNGSI INPUT TEKS & SPEECH RECOGNITION
// =========================================================================

async function handleTextCommand(command) {
    if (isProcessing || isSpeaking) return;
    if (!command.trim()) return;
    if (!validateSetup()) return;

    isProcessing = true; 
    talkButton.disabled = true;
    sendButton.disabled = true;
    refreshButton.disabled = true; 
    chatInput.disabled = true; // Dinonaktifkan selama pemrosesan
    
    const commandToProcess = command.trim();
    chatInput.value = ''; 
    
    transcriptText.textContent = `Anda: ${commandToProcess}`;

    try {
        const reply = await getGeminiReply(commandToProcess);
        transcriptText.textContent = `Pou: ${reply}`;
        speakResponse(reply); 
    } catch (error) {
        console.error("Text command failed:", error);
    } finally {
        // Kontrol input di-handle di speakResponse
    }
}

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'id-ID';
    recognition.interimResults = false;

    recognition.onstart = () => {
        setCharacterListening(true);
        talkButton.textContent = 'Mendengarkan... (Tekan untuk Stop)';
        statusText.textContent = 'Silakan Bicara ke Pou...';
        transcriptText.textContent = '';
        sendButton.disabled = true; 
        refreshButton.disabled = true; 
        chatInput.disabled = true; 
    };

    recognition.onend = () => {
        setCharacterListening(false);
        talkButton.textContent = 'Mulai Bicara (Mic)';
        sendButton.disabled = false; 
        refreshButton.disabled = false; 
        chatInput.disabled = false; // Diaktifkan kembali setelah berhenti mendengarkan
        
        if (!isProcessing) { 
            statusText.textContent = 'Siap. Tekan "Mulai Bicara" atau ketik pesan.';
            talkButton.disabled = false;
        }
    };

    recognition.onresult = async (event) => {
        const command = event.results[0][0].transcript;
        
        isProcessing = true; 
        talkButton.disabled = true; 
        
        const reply = await getGeminiReply(command);
        
        transcriptText.textContent = `Pou: ${reply}`;
        speakResponse(reply); 
    };

    recognition.onerror = (event) => {
        console.error('Speech Recognition Error:', event.error);
        
        setCharacterListening(false);
        isProcessing = false;
        talkButton.disabled = false;
        sendButton.disabled = false; 
        refreshButton.disabled = false; 
        chatInput.disabled = false; // Diaktifkan kembali saat ada error Mic
        talkButton.textContent = 'Mulai Bicara (Mic)';
        
        if (event.error === 'no-speech') {
             statusText.textContent = 'Tidak ada ucapan terdeteksi. Coba lagi.';
        } else if (event.error === 'not-allowed') {
             statusText.textContent = 'Izin Mic Ditolak. Izinkan di pengaturan browser.';
        } else {
             statusText.textContent = `Mik Error: ${event.error}. Siap.`;
        }
    };
    
} 

function startListening() {
    if (!validateSetup()) return;
    if (isProcessing || isSpeaking) return;

    setTimeout(() => {
        try {
            recognition.start();
        } catch (e) {
            console.warn('Recognition start failed:', e);
            talkButton.disabled = false;
            statusText.textContent = 'Gagal mulai mendengarkan. Coba lagi.';
        }
    }, 100); 
}

// =========================================================================
//                          INISIALISASI
// =========================================================================

gyroButton.addEventListener('click', requestSensorPermission);

// LOGIKA TOMBOL BICARA
talkButton.addEventListener('click', () => {
    if (!validateSetup()) return;

    if (isListening) {
        // Stop: Feedback instan
        recognition.stop();
        setCharacterListening(false);
        talkButton.textContent = 'Mulai Bicara (Mic)';
        statusText.textContent = 'Dihentikan. Siap.';
        talkButton.disabled = false;
        sendButton.disabled = false;
        refreshButton.disabled = false;
        chatInput.disabled = false; // Diaktifkan kembali saat Stop Bicara
    } else if (!isSpeaking && !isProcessing) {
        // Start (Langsung mulai mendengarkan)
        talkButton.disabled = true;
        startListening();
    }
});

// LOGIKA TOMBOL KIRIM
sendButton.addEventListener('click', () => {
    const command = chatInput.value;
    handleTextCommand(command);
});

// LOGIKA TOMBOL BERSIHKAN CHAT
refreshButton.addEventListener('click', clearChatAndHistory);

chatInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
        event.preventDefault(); // Mencegah baris baru di input
        sendButton.click();
    }
});


window.addEventListener('load', () => {
    setRandomBlinkInterval();
    moveEyesRandomly();
    
    if (validateSetup()) {
        statusText.innerHTML = 'Siap. Tekan "Mulai Bicara" atau ketik pesan.';
        talkButton.disabled = !SpeechRecognition;
        sendButton.disabled = false;
        refreshButton.disabled = false;
    }
    
    // Hapus animasi CSS bawaan Pou
    const styleTag = document.getElementById('dcoder_stylesheet');
    if (styleTag) {
        styleTag.textContent = styleTag.textContent.replace(/@keyframes blink {[^}]*}/g, '');
        styleTag.textContent = styleTag.textContent.replace(/@keyframes movePupil {[^}]*}/g, '');
        styleTag.textContent = styleTag.textContent.replace(/@keyframes mouth {[^}]*}/g, '');
        styleTag.textContent = styleTag.textContent.replace(/animation: [^;]*;/g, ' ');
    }
});
</script> 
 </body>
</html>
